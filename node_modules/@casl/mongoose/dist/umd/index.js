"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var r=require("mongoose"),n=require("@casl/ability/extra"),t=require("@casl/ability");function e(r){var n=r.conditions;return r.inverted?{$nor:[n]}:n}function i(r){return n.rulesToQuery(r,(arguments.length<=2?void 0:arguments[2])||"read",arguments.length<=1?void 0:arguments[1],e)}function o(r,n){for(var t=arguments.length,e=new Array(t>2?t-2:0),i=2;i<t;i++)e[i-2]=arguments[i];var o=e[0],u=e[2];return o.__forbiddenByCasl__?"function"==typeof u?u(null,n):Promise.resolve(n):(o.hasOwnProperty("__forbiddenByCasl__")&&delete o.__forbiddenByCasl__,this[r].apply(this,e))}function u(n,t){var e=this.modelName;if(e||(e="model"in this?this.model.modelName:null),!e)throw new TypeError("Cannot detect model name to return accessible records");var u=i(n,e,t);return null===u?function(r){var n;r.where(((n={}).__forbiddenByCasl__=1,n));var t=r,e=Object.create(t._collection);return t._collection=e,e.find=o.bind(e,"find",[]),e.findOne=o.bind(e,"findOne",null),e.count=o.bind(e,"count",0),r}(this.where()):this instanceof r.Query?this.and([u]):this.where({$and:[u]})}function c(){return(c=Object.assign||function(r){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var e in t)Object.prototype.hasOwnProperty.call(t,e)&&(r[e]=t[e])}return r}).apply(this,arguments)}var s=function(r){return Object.keys(r.paths)};function a(){var r;return function(n,e){if(!r){var i=e&&"only"in e?t.wrapArray(e.only):function(r,n){var e=n.getFields(r);if(!n||!("except"in n))return e;var i=t.wrapArray(n.except);return e.filter((function(r){return-1===i.indexOf(r)}))}(n,e);r=function(r){return r.fields||i}}return r}}exports.accessibleFieldsPlugin=function(r,t){var e=c({getFields:s},t),i=a();function o(t,o){var u="function"==typeof this?this.modelName:this;return n.permittedFieldsOf(t,o||"read",u,{fieldsFrom:i(r,e)})}r.statics.accessibleFieldsBy=o,r.method("accessibleFieldsBy",o)},exports.accessibleRecordsPlugin=function(r){r.query.accessibleBy=u,r.statics.accessibleBy=u},exports.getSchemaPaths=s,exports.toMongoQuery=i;
//# sourceMappingURL=index.js.map
